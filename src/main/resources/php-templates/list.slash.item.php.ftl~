<#function titleCase text>
  <#local len = text?length />
  <#if (len>1)>
    <#return text[0]?upper_case + text[1..]> 
  <#else>
    <#return text?upper_case>
  </#if>
</#function>
<?php
/* list/${item.name}.php */
/* Generated by AppsoFluna */

$relative_path="../";
include($relative_path.'functions.php');
include($relative_path.'login.php');
$is_logged_in = isset($_SESSION['login_user']);

function getAll${titleCase(item.name)}Records() {
	global $db_prefix;
	$conn = getConnection();
	if (!$conn) {
		return null;
	}

	$sql = "SELECT id<#list item.fields as field>, ${field.name}<#if field.type == 'period'>_from, ${field.name}_to</#if><#if field.type == 'item'>_id</#if></#list> FROM ".$db_prefix."${item.name}";
	$result = mysqli_query($conn, $sql);

	$all_${item.name}_records = array();
	if ($result && mysqli_num_rows($result) > 0) {
		while($row = mysqli_fetch_assoc($result)) {
			<#list item.fields as field>
			<#if field.type == 'item'>
				$ref_${field.name}_id = $row['${field.name}_id'];
				if ($ref_${field.name}_id) {
					$ref_${field.name}_sql = "SELECT <#list field.extra.refFields as refField>${refField}<#sep>,</#list> FROM ".$db_prefix."${field.extra.refItem} WHERE id = $ref_${field.name}_id";
					$ref_${field.name}_result = mysqli_query($conn,$ref_${field.name}_sql);
					if ($ref_${field.name}_result && mysqli_num_rows($ref_${field.name}_result) > 0 && $ref_${field.name}_row = mysqli_fetch_assoc($ref_${field.name}_result)) {
						$${field.name}_label = <#list field.extra.refFields as refField>$ref_${field.name}_row['${refField}']<#sep>.' '.</#list>;
						$row['${field.name}_label'] = $${field.name}_label;
					} else {
						$row['${field.name}_label'] = '';
					}
				} else {
					$row['${field.name}_label'] = '';
				}
			</#if>
			</#list>
			$all_${item.name}_records[] = $row;
		}
	}
	mysqli_close($conn);

	return $all_${item.name}_records;
}

?>

<html>
 <head>
  <?php include($relative_path."preheaders.php"); ?>
  <title>
	<?php echo $sa_appname.' - '.$item_labels['${item.name}']; ?> Records
  </title>
  <?php include($relative_path."headers.php"); ?>

  <script>
    $(document).ready(function() {
        $('#tbl_data').DataTable();
    });
  </script>
 </head>
 <body>

<div id="main" class="container" role="main">
<?php
if ($is_logged_in) {
	$loggedInUser = $_SESSION['login_user'];
	$is_primary = isPrimaryByUsername($loggedInUser);
	$rolename = getRoleByUsername($loggedInUser);

	$is_allowed = isItemAllowed('${item.name}',$rolename);
	$is_creatable = isItemCreatable('${item.name}',$rolename);
	$is_editable = isItemEditable('${item.name}',$rolename);
	$is_deletable = isItemDeletable('${item.name}',$rolename);
		?>

<nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="<?php echo $relative_path; ?>index.php"><?php echo $sa_appname; ?></a>
    </div>
    <ul class="nav navbar-nav">
        <li class="active"><a href="#"><?php echo $item_labels['${item.name}']; ?> Records</a></li>
<?php 
	if ($is_allowed && $is_creatable) { ?>
<li><a   href="<?php echo $relative_path; ?>single/${item.name}.php?page=create">Create New</a></li>
	<?php }
?>
    </ul>
    <ul class="nav navbar-nav navbar-right">
      <li><a href="#">Logged as <?php echo $loggedInUser; ?></a></li>
      <li><a href="<?php echo $relative_path; ?>logout.php">Logout</a></li>
      <?php if ($is_primary) { ?><li><a href="<?php echo $relative_path; ?>users.php">Users</a></li><?php } ?>
      <li><a href="<?php echo $relative_path; ?>change-password.php">Change Password</a></li>
      <li><a href="#"></a></li>
    </ul>
  </div>
</nav>

<?php
	if ($is_allowed) {
?>
		<table id="tbl_data" class="table table-striped table-bordered" cellspacing="0" width="100%">
			<thead>
				<tr>
					<#list item.fields as field>
					<td>${field.label}</td>
					</#list>
					<td><?php if ($is_editable) echo "#"; ?></td>
				</tr>
			</thead>
			<tbody>
			<?php
			$records = getAll${titleCase(item.name)}Records();
			foreach ($records as $record) {
				?>
				<tr>
					<#list item.fields as field>
					  <td><?php echo $record["${field.name}<#if field.type == 'period'>_from"];
                                                    echo ' - ';
                                                    echo $record["${field.name}_to</#if><#if field.type == 'item'>_label</#if>"]; ?></td>
					</#list>
				  <td>
                                        <?php if ($is_editable) { ?> <a class="btn btn-default" href="<?php echo $relative_path; ?>single/${item.name}.php?page=edit&id=<?php echo $record['id']; ?>">edit</a>
					<?php 
					}
					if ($is_deletable) { ?>
				    		<a class="btn btn-default" href="<?php echo $relative_path; ?>single/${field.name}.php?page=delete&id=<?php echo $record['id']; ?>">delete</a>
					<?php } ?>
				  </td>
				</tr>
			<?php } ?>
			<tbody>
		</table>
		<?php
	} else {
		?>
		This page is restricted.
		<?php
	}
} else {
	include($relative_path.'login-form.php');
}
include($relative_path.'footer.php');
?>
</div>
 </body>
</html>
